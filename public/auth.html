<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VideoChat - Secure Access</title>
  <style>
    :root {
      --primary: #818cf8;
      --primary-hover: #6366f1;
      --bg: #0f172a;
      --card-bg: rgba(15, 23, 42, 0.6);
      --border: rgba(255, 255, 255, 0.1);
      --text-muted: #94a3b8;
      --success: #10b981;
      --error: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: #020617;
      background-image: 
        radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0, transparent 50%), 
        radial-gradient(at 100% 0%, rgba(168, 85, 247, 0.15) 0, transparent 50%);
      color: white;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      overflow: hidden;
    }

    /* Glass Card */
    .auth-container {
      position: relative;
      width: 100%;
      max-width: 420px;
      padding: 20px;
      animation: fadeIn 0.6s ease-out;
    }

    .glass-card {
      background: var(--card-bg);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 40px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Header */
    .header { text-align: center; margin-bottom: 32px; }
    h2 { font-size: 1.875rem; font-weight: 700; margin: 0 0 8px 0; letter-spacing: -0.025em; }
    .subtitle { color: var(--text-muted); font-size: 0.95rem; line-height: 1.5; }

    /* Form Elements */
    .form-group { margin-bottom: 20px; position: relative; }
    label { 
      display: block; 
      font-size: 0.8125rem; 
      font-weight: 500; 
      color: var(--text-muted); 
      margin-bottom: 8px; 
      transition: color 0.2s;
    }
    
    .input-wrapper { position: relative; }
    
    input {
      width: 100%;
      background: rgba(0, 0, 0, 0.2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 16px;
      color: white;
      font-size: 1rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      background: rgba(0, 0, 0, 0.4);
      box-shadow: 0 0 0 4px rgba(129, 140, 248, 0.15);
    }

    input::placeholder { color: #475569; }

    /* Buttons */
    button.main-btn {
      width: 100%;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 14px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
    }

    button.main-btn:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
    }

    button.main-btn:active { transform: translateY(0); }
    
    button.main-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    /* Footer / Toggles */
    .form-footer {
      margin-top: 24px;
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .link-btn {
      color: var(--primary);
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: color 0.2s;
    }

    .link-btn:hover { color: var(--primary-hover); text-decoration: underline; }

    .forgot-pass {
      display: block;
      margin-top: 12px;
      font-size: 0.8125rem;
    }

    /* Custom Toast Notification */
    #toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      min-width: 300px;
      padding: 16px;
      border-radius: 12px;
      background: rgba(30, 41, 59, 0.9);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border);
      color: white;
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      transform: translateX(120%);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .toast.show { transform: translateX(0); }

    .toast-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .toast.success .toast-icon { background: var(--success); box-shadow: 0 0 10px var(--success); }
    .toast.error .toast-icon { background: var(--error); box-shadow: 0 0 10px var(--error); }
    .toast-message { font-size: 0.875rem; font-weight: 500; }

    /* Spinner */
    .spinner {
      width: 18px;
      height: 18px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      display: none;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading .spinner { display: block; }
    .loading .btn-text { display: none; }
  </style>
</head>
<body>

<div id="toast-container"></div>

<div class="auth-container">
  <div class="glass-card">
    <div class="header">
      <h2 id="title">Welcome Back</h2>
      <p class="subtitle" id="subtitle">Enter your credentials to access your dashboard.</p>
    </div>

    <form id="authForm" onsubmit="event.preventDefault(); handleAction();">
      <!-- Main Credentials -->
      <div class="form-group" id="user-group">
        <label id="user-label">Username or Email</label>
        <div class="input-wrapper">
          <input type="text" id="username" placeholder="johndoe" autocomplete="username">
        </div>
      </div>
      
      <!-- Registration/Reset Email -->
      <div class="form-group" id="email-group" style="display: none;">
        <label>Email Address</label>
        <div class="input-wrapper">
          <input type="email" id="email" placeholder="alex@example.com" autocomplete="email">
        </div>
      </div>

      <!-- Password Field -->
      <div class="form-group" id="pass-group">
        <label id="pass-label">Password</label>
        <div class="input-wrapper">
          <input type="password" id="password" placeholder="••••••••" autocomplete="current-password">
        </div>
      </div>

      <!-- OTP Field -->
      <div class="form-group" id="otp-group" style="display: none;">
        <label>Security Code</label>
        <div class="input-wrapper">
          <input type="text" id="otp" placeholder="6-digit code" maxlength="6">
        </div>
      </div>

      <button type="submit" id="mainBtn" class="main-btn">
        <span class="spinner"></span>
        <span class="btn-text">Sign In</span>
      </button>
    </form>

    <div class="form-footer">
      <div id="toggle-section">
        <span id="toggleTextPrefix">Don't have an account?</span> 
        <span class="link-btn" onclick="toggleMode()" id="toggleBtn">Register</span>
      </div>
      <span class="link-btn forgot-pass" onclick="enterForgotMode()" id="forgotText">Forgot password?</span>
    </div>
  </div>
</div>

<script>
let mode = "login"; // login, register, forgot, reset
let isLoading = false;

function showToast(message, type = 'error') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <div class="toast-icon"></div>
    <div class="toast-message">${message}</div>
  `;
  container.appendChild(toast);

  // Animate in
  setTimeout(() => toast.classList.add('show'), 10);

  // Remove after 4s
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

function toggleMode() {
  if (mode === 'forgot' || mode === 'reset') {
    mode = 'login';
  } else {
    mode = mode === "login" ? "register" : "login";
  }
  updateUI();
}

function enterForgotMode() {
  mode = "forgot";
  updateUI();
}

function updateUI() {
  const isLogin = mode === "login";
  const isRegister = mode === "register";
  const isForgot = mode === "forgot";
  const isReset = mode === "reset";

  // Titles & Subtitles
  document.getElementById("title").innerText = 
    isLogin ? "Welcome Back" : 
    isRegister ? "Create Account" : 
    isForgot ? "Recover Account" : "Verify Reset";
    
  document.getElementById("subtitle").innerText = 
    isLogin ? "Enter your credentials to access your dashboard." :
    isRegister ? "Join our community and start chatting today." :
    isForgot ? "We'll send a security code to your email." :
    "Check your server logs for the 6-digit verification code.";
  
  // Field Visibility
  document.getElementById("user-group").style.display = (isLogin || isRegister) ? "block" : "none";
  document.getElementById("email-group").style.display = (isRegister || isForgot || isReset) ? "block" : "none";
  document.getElementById("pass-group").style.display = (isLogin || isRegister || isReset) ? "block" : "none";
  document.getElementById("otp-group").style.display = isReset ? "block" : "none";
  
  // Labels
  document.getElementById("user-label").innerText = isLogin ? "Username or Email" : "Username";
  document.getElementById("pass-label").innerText = isReset ? "New Password" : "Password";
  
  // Button Text
  document.querySelector("#mainBtn .btn-text").innerText = 
    isLogin ? "Sign In" : 
    isRegister ? "Register Now" : 
    isForgot ? "Send Reset Code" : "Update Password";

  // Footer Controls
  const togglePrefix = document.getElementById("toggleTextPrefix");
  const toggleBtn = document.getElementById("toggleBtn");
  const forgotBtn = document.getElementById("forgotText");

  if (isLogin) {
    togglePrefix.innerText = "Don't have an account?";
    toggleBtn.innerText = "Register";
    forgotBtn.style.display = "block";
  } else if (isRegister) {
    togglePrefix.innerText = "Already have an account?";
    toggleBtn.innerText = "Sign In";
    forgotBtn.style.display = "none";
  } else {
    togglePrefix.innerText = "Changed your mind?";
    toggleBtn.innerText = "Back to Login";
    forgotBtn.style.display = "none";
  }
}

async function handleAction() {
  if (isLoading) return;

  const username = document.getElementById("username").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const otp = document.getElementById("otp").value.trim();
  const btn = document.getElementById("mainBtn");

  // Basic Validation
  if (mode === "login" && (!username || !password)) return showToast("Please fill in all fields");
  if (mode === "register" && (!username || !email || !password)) return showToast("All fields are required");
  if (mode === "forgot" && !email) return showToast("Email is required to reset password");
  if (mode === "reset" && (!otp || !password)) return showToast("OTP and New Password are required");

  let url = "";
  let payload = {};

  if (mode === "login") {
    url = "/login";
    payload = { username, password };
  } else if (mode === "register") {
    url = "/register";
    payload = { username, email, password };
  } else if (mode === "forgot") {
    url = "/request-otp";
    payload = { email };
  } else if (mode === "reset") {
    url = "/reset-password";
    payload = { email, otp, newPassword: password };
  }

  setLoading(true);

  try {
    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    
    if (!data.success) {
      showToast(data.message || "An error occurred");
    } else {
      if (mode === "login") {
        showToast("Login successful! Redirecting...", "success");
        localStorage.setItem("token", data.token);
        localStorage.setItem("username", data.username);
        setTimeout(() => window.location.href = "/index.html", 1000);
      } else if (mode === "forgot") {
        showToast("Code sent! Check your server logs.", "success");
        mode = "reset";
        updateUI();
      } else if (mode === "register") {
        showToast("Account created! You can now log in.", "success");
        mode = "login";
        updateUI();
      } else {
        showToast("Password updated successfully.", "success");
        mode = "login";
        updateUI();
      }
    }
  } catch (e) { 
    showToast("Connection failed. Is the server running?"); 
  } finally {
    setLoading(false);
  }
}

function setLoading(val) {
  isLoading = val;
  const btn = document.getElementById("mainBtn");
  if (val) btn.classList.add('loading');
  else btn.classList.remove('loading');
  btn.disabled = val;
}

// Initial UI Setup
updateUI();
</script>
</body>
</html>